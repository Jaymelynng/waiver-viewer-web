<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Waiver Hub · Admin</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: #737373;
  color: #1f2937;
  min-height: 100vh;
}

/* ── Header ── */
.admin-header {
  background: linear-gradient(135deg, #5a5a5a 0%, #737373 100%);
  border-bottom: 2px solid #b48f8f;
  padding: 18px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.admin-header h1 { font-size: 22px; color: #fff; font-weight: 700; }
.admin-header .subtitle { font-size: 13px; color: #d4c5c5; margin-top: 2px; }
.header-left { display: flex; align-items: center; gap: 14px; }
.header-left a {
  color: #d4c5c5;
  text-decoration: none;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: color .2s;
}
.header-left a:hover { color: #fff; }
.header-right { display: flex; align-items: center; gap: 10px; }
.save-status { font-size: 12px; color: #c5b8b8; }
.save-status.unsaved { color: #f59e0b; font-weight: 600; }

.btn {
  padding: 9px 20px;
  font-size: 13px;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-save {
  background: #b48f8f;
  color: #fff;
  box-shadow: 0 3px 0 #8b6f6f, 0 4px 8px rgba(0,0,0,0.25);
}
.btn-save:hover { transform: translateY(1px); box-shadow: 0 2px 0 #8b6f6f, 0 3px 6px rgba(0,0,0,0.25); }
.btn-save:active { transform: translateY(3px); box-shadow: 0 0 0 #8b6f6f; }
.btn-save:disabled { opacity: .5; cursor: not-allowed; transform: none; }
.btn-light {
  background: rgba(255,255,255,0.15);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.2);
}
.btn-light:hover { background: rgba(255,255,255,0.25); }

/* ── Login ── */
#loginScreen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
}
.login-card {
  background: linear-gradient(145deg, #fafbfc 0%, #f0f2f5 100%);
  border: 2px solid #c4cad4;
  border-radius: 14px;
  box-shadow: 0 6px 0 #c4cad4, 0 8px 20px rgba(0,0,0,0.2);
  padding: 40px;
  width: 380px;
  text-align: center;
}
.login-card h1 { font-size: 24px; margin-bottom: 4px; color: #1f2937; }
.login-card p { font-size: 14px; color: #6b7280; margin-bottom: 24px; }
.login-card input {
  width: 100%;
  padding: 14px 16px;
  font-size: 24px;
  letter-spacing: 10px;
  text-align: center;
  border: 2px solid #d1d5db;
  border-radius: 10px;
  outline: none;
  transition: border-color .2s;
  background: #fff;
}
.login-card input:focus { border-color: #b48f8f; }
.login-card button {
  width: 100%;
  margin-top: 16px;
  padding: 14px;
  font-size: 15px;
  font-weight: 600;
  color: #fff;
  background: #b48f8f;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  box-shadow: 0 3px 0 #8b6f6f;
  transition: all .2s;
}
.login-card button:hover { transform: translateY(1px); box-shadow: 0 2px 0 #8b6f6f; }
.login-card button:active { transform: translateY(3px); box-shadow: none; }
.login-error { color: #ef4444; font-size: 13px; margin-top: 12px; display: none; }

/* ── Editor ── */
#editorScreen { display: none; }
.editor-body { max-width: 900px; margin: 0 auto; padding: 24px 20px 60px; }

/* ── Tabs ── */
.tabs { display: flex; gap: 4px; margin-bottom: 20px; }
.tab {
  padding: 12px 24px;
  font-size: 14px;
  font-weight: 600;
  background: rgba(255,255,255,0.15);
  border: 2px solid transparent;
  border-radius: 12px 12px 0 0;
  cursor: pointer;
  color: #e5e7eb;
  transition: all .2s;
}
.tab.active {
  background: #f0f2f5;
  color: #1f2937;
  border-color: #c4cad4;
  border-bottom-color: #f0f2f5;
}

/* ── Help Tip ── */
.help-tip {
  background: linear-gradient(145deg, #fafbfc 0%, #f0f2f5 100%);
  border: 2px solid #c4cad4;
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 0 #c4cad4, 0 6px 12px rgba(0,0,0,0.1);
}
.help-tip h3 { font-size: 13px; color: #6b7280; margin-bottom: 8px; }
.help-tip p { font-size: 13px; color: #4b5563; line-height: 1.6; }
.help-tip .vars {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}
.var-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #e8d5d5;
  border: 1px solid #d4b8b8;
  border-radius: 20px;
  padding: 5px 14px;
  font-size: 12px;
  cursor: pointer;
  transition: all .15s;
  color: #5a3e3e;
  font-weight: 600;
}
.var-pill:hover { background: #d4b8b8; }
.var-pill span { font-weight: 400; color: #7a6060; }

/* ── Section Cards ── */
.section-card {
  background: linear-gradient(145deg, #fafbfc 0%, #f0f2f5 100%);
  border: 2px solid #c4cad4;
  border-radius: 12px;
  margin-bottom: 14px;
  overflow: hidden;
  box-shadow: 0 4px 0 #c4cad4, 0 6px 12px rgba(0,0,0,0.1);
}
.section-label {
  padding: 10px 16px;
  background: #e8e8e8;
  border-bottom: 1px solid #d1d5db;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}
.section-label .label-text {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .5px;
  color: #6b7280;
}
.section-label .label-badge {
  font-size: 10px;
  font-weight: 700;
  color: #fff;
  padding: 2px 8px;
  border-radius: 4px;
  text-transform: uppercase;
}
.badge-title { background: #b48f8f; }
.badge-paragraph { background: #6b7280; }
.badge-heading { background: #5a5a5a; }
.badge-list { background: #8b6f6f; }
.badge-indent { background: #9ca3af; }
.badge-sig { background: #4b5563; }

.section-actions { display: flex; gap: 2px; }
.section-actions button {
  background: none;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 14px;
  color: #9ca3af;
  transition: all .15s;
}
.section-actions button:hover { background: #d1d5db; color: #374151; }

/* ── Editable Content Areas ── */
.content-area {
  padding: 16px;
  min-height: 60px;
  font-size: 14px;
  line-height: 1.8;
  outline: none;
  cursor: text;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.content-area:focus {
  background: #fff;
}
.content-area:empty::before {
  content: 'Click to edit...';
  color: #9ca3af;
  font-style: italic;
}

/* Style for headings in content */
.content-area.heading-content {
  font-size: 16px;
  font-weight: 700;
}

/* ── List Items ── */
.list-content { padding: 16px; }
.list-item-row {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  margin-bottom: 8px;
}
.list-item-row .marker {
  font-size: 14px;
  color: #6b7280;
  padding-top: 2px;
  min-width: 20px;
  text-align: right;
  font-weight: 600;
}
.list-item-row .item-content {
  flex: 1;
  min-height: 30px;
  padding: 8px 12px;
  font-size: 14px;
  line-height: 1.7;
  outline: none;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  background: #fff;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.list-item-row .item-content:focus {
  border-color: #b48f8f;
}
.list-item-row .item-content:empty::before {
  content: 'Click to edit...';
  color: #9ca3af;
  font-style: italic;
}
.list-item-row button {
  background: none;
  border: none;
  cursor: pointer;
  color: #d1d5db;
  padding: 6px;
  font-size: 16px;
  border-radius: 4px;
}
.list-item-row button:hover { color: #ef4444; background: #fef2f2; }

.add-item-btn {
  font-size: 13px;
  color: #8b6f6f;
  background: none;
  border: 2px dashed #c4cad4;
  border-radius: 8px;
  padding: 6px 14px;
  cursor: pointer;
  transition: all .15s;
  margin-top: 4px;
}
.add-item-btn:hover { border-color: #b48f8f; color: #b48f8f; background: #faf5f5; }

/* ── Signature Preview ── */
.sig-preview {
  padding: 16px;
  font-size: 13px;
  color: #6b7280;
  font-style: italic;
}

/* ── Add Section Buttons ── */
.add-section {
  display: flex;
  gap: 8px;
  margin-top: 16px;
  flex-wrap: wrap;
}
.add-section button {
  font-size: 13px;
  padding: 8px 16px;
  border-radius: 10px;
  border: 2px dashed #c4cad4;
  background: rgba(255,255,255,0.5);
  cursor: pointer;
  color: #6b7280;
  font-weight: 600;
  transition: all .15s;
}
.add-section button:hover { border-color: #b48f8f; color: #8b6f6f; background: #faf5f5; }

/* ── Gym Management ── */
.gym-card-admin {
  background: linear-gradient(145deg, #fafbfc 0%, #f0f2f5 100%);
  border: 2px solid #c4cad4;
  border-radius: 12px;
  margin-bottom: 14px;
  overflow: hidden;
  box-shadow: 0 4px 0 #c4cad4, 0 6px 12px rgba(0,0,0,0.1);
}
.gym-card-header {
  padding: 12px 16px;
  background: #e8e8e8;
  border-bottom: 1px solid #d1d5db;
  display: flex;
  align-items: center;
  gap: 12px;
}
.gym-card-header .gym-logo-preview {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  object-fit: contain;
  background: #fff;
  border: 1px solid #d1d5db;
}
.gym-card-header .gym-name-label {
  font-size: 15px;
  font-weight: 700;
  color: #1f2937;
  flex: 1;
}
.gym-card-header .color-dots {
  display: flex;
  gap: 4px;
}
.gym-card-header .color-dot {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.gym-card-body {
  padding: 16px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}
.gym-field label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  color: #6b7280;
  margin-bottom: 4px;
  letter-spacing: .5px;
}
.gym-field input, .gym-field select {
  width: 100%;
  padding: 8px 12px;
  font-size: 14px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  outline: none;
  transition: border-color .2s;
  background: #fff;
}
.gym-field input:focus { border-color: #b48f8f; }
.gym-field input[type="color"] {
  height: 40px;
  padding: 4px;
  cursor: pointer;
}
.gym-field.full-width { grid-column: 1 / -1; }
.gym-card-actions {
  padding: 0 16px 16px;
  display: flex;
  justify-content: flex-end;
}
.btn-remove {
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 600;
  color: #ef4444;
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  cursor: pointer;
  transition: all .15s;
}
.btn-remove:hover { background: #fee2e2; border-color: #ef4444; }

.add-gym-btn {
  width: 100%;
  padding: 14px;
  font-size: 14px;
  font-weight: 600;
  color: #8b6f6f;
  background: rgba(255,255,255,0.5);
  border: 2px dashed #c4cad4;
  border-radius: 12px;
  cursor: pointer;
  transition: all .15s;
  margin-top: 8px;
}
.add-gym-btn:hover { border-color: #b48f8f; color: #b48f8f; background: #faf5f5; }

/* ── Preview Modal ── */
#previewModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.6);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
#previewModal.open { display: flex; }
.preview-container {
  background: #fff;
  border-radius: 14px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.preview-toolbar {
  position: sticky;
  top: 0;
  background: #fff;
  padding: 14px 20px;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1;
}
.preview-toolbar select {
  padding: 8px 12px;
  border: 2px solid #d1d5db;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
}
.preview-toolbar .close-btn {
  margin-left: auto;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #9ca3af;
  padding: 4px 8px;
}
.preview-toolbar .close-btn:hover { color: #374151; }
.preview-body { padding: 30px; }
.preview-body h1 { font-size: 14px; text-align: center; margin: 16px 0 8px; color: #333; }
.preview-body h2 { font-size: 13px; margin: 14px 0 6px; }
.preview-body p { font-size: 12px; line-height: 1.6; margin-bottom: 8px; }
.preview-body ul, .preview-body ol { font-size: 12px; line-height: 1.6; margin: 0 0 8px 20px; }
.preview-body .warning { background: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; font-size: 11px; font-weight: 700; text-align: center; border-radius: 4px; margin-bottom: 12px; }
.preview-body .policy-intro { background: #f0f4ff; border: 1px solid #b8c9ff; padding: 10px; border-radius: 6px; margin-bottom: 12px; font-size: 12px; text-align: center; }
.preview-body .sig-area { display: flex; gap: 10px; margin-top: 16px; }
.preview-body .sig-line { border-bottom: 1px solid #000; height: 20px; }
.preview-body .sig-label { font-size: 10px; color: #666; margin-top: 2px; }

/* ── Toast ── */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: #374151;
  color: #fff;
  padding: 12px 28px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: transform .3s;
  z-index: 2000;
}
.toast.show { transform: translateX(-50%) translateY(0); }

/* ── Responsive ── */
@media (max-width: 640px) {
  .admin-header { flex-direction: column; gap: 10px; text-align: center; }
  .header-right { flex-wrap: wrap; justify-content: center; }
  .editor-body { padding: 16px 12px; }
  .tabs { overflow-x: auto; }
  .preview-container { width: 98%; }
}
</style>
</head>
<body>

<!-- ═══════════ LOGIN ═══════════ -->
<div id="loginScreen">
  <div class="login-card">
    <h1>Waiver Hub</h1>
    <p>Enter your admin PIN</p>
    <input type="password" id="pinInput" maxlength="8" inputmode="numeric" placeholder="· · · · · ·" autocomplete="off">
    <button onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ═══════════ EDITOR ═══════════ -->
<div id="editorScreen">
  <div class="admin-header">
    <div>
      <div class="header-left">
        <a href="/">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          Back to Site
        </a>
      </div>
      <h1>Waiver Hub · Admin</h1>
      <div class="subtitle">Edit your waiver and policy documents</div>
    </div>
    <div class="header-right">
      <span class="save-status" id="saveStatus">All changes saved</span>
      <button class="btn btn-light" onclick="openPreview()">Preview</button>
      <button class="btn btn-save" id="saveBtn" onclick="saveContent()">Save Changes</button>
      <button class="btn btn-light" onclick="doLogout()">Logout</button>
    </div>
  </div>

  <div class="editor-body">
    <!-- Help -->
    <div class="help-tip">
      <h3>How to edit</h3>
      <p>Click on any text below to edit it directly. <strong>Bold text</strong> will show as bold. Use these placeholders and they'll be replaced with each gym's info:</p>
      <div class="vars">
        <div class="var-pill" onclick="copyVar('{{gym.name}}')">{{gym.name}} <span>· gym name</span></div>
        <div class="var-pill" onclick="copyVar('{{gym.fee}}')">{{gym.fee}} <span>· annual fee</span></div>
        <div class="var-pill" onclick="copyVar('{{gym.domain}}')">{{gym.domain}} <span>· email domain</span></div>
        <div class="var-pill" onclick="copyVar('{{gym.email}}')">{{gym.email}} <span>· gym email</span></div>
        <div class="var-pill" onclick="copyVar('{{gym.abbr}}')">{{gym.abbr}} <span>· abbreviation</span></div>
        <div class="var-pill" onclick="copyVar('{{gym.color}}')">{{gym.color}} <span>· primary color</span></div>
        <div class="var-pill" onclick="copyVar('{{gym.color2}}')">{{gym.color2}} <span>· secondary color</span></div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab" id="tabGyms" onclick="switchTab('gyms')">Gyms</button>
      <button class="tab active" id="tabWaiver" onclick="switchTab('waiver')">Release & Waiver</button>
      <button class="tab" id="tabPolicy" onclick="switchTab('policy')">Policies & Procedures</button>
    </div>

    <!-- Gym Editor -->
    <div id="gymsEditor" style="display:none;"></div>

    <!-- Waiver Editor -->
    <div id="waiverEditor"></div>

    <!-- Policy Editor -->
    <div id="policyEditor" style="display:none;"></div>
  </div>
</div>

<!-- ═══════════ PREVIEW ═══════════ -->
<div id="previewModal" onclick="if(event.target===this)closePreview()">
  <div class="preview-container">
    <div class="preview-toolbar">
      <label style="font-weight:600;">Preview as:</label>
      <select id="previewGym" onchange="renderPreview()"></select>
      <select id="previewDoc" onchange="renderPreview()">
        <option value="waiver">Release & Waiver</option>
        <option value="policy">Policies & Procedures</option>
      </select>
      <button class="close-btn" onclick="closePreview()">&times;</button>
    </div>
    <div class="preview-body" id="previewBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ═══════════════════════════════════════
   ADMIN EDITOR — Waiver Hub
   ═══════════════════════════════════════ */

var TOKEN = localStorage.getItem('admin_token') || null;
var content = null;
var gyms = null;
var activeTab = 'waiver';
var hasUnsaved = false;

var DEFAULT_GYMS = [
  { name: 'Capital Gymnastics Cedar Park',  abbr: 'CCP', color: '#1f53a3', color2: '#bf0a30', logo: 'ccp_cpf logo - 500x500.png', email: 'info@capgymcpk.com', fee: '55', domain: 'capgymcpk.com' },
  { name: 'Capital Gymnastics Pflugerville', abbr: 'CPF', color: '#1f53a3', color2: '#bf0a30', logo: 'ccp_cpf logo - 500x500.png', email: 'info@capgympfl.com', fee: '55', domain: 'capgympfl.com' },
  { name: 'Capital Gymnastics Round Rock',   abbr: 'CRR', color: '#ff1493', color2: '#c0c0c0', logo: 'CRR-logo - 500x500.png', email: 'info@capgymrnd.com', fee: '55', domain: 'capgymrnd.com' },
  { name: 'Rowland Ballard - Atascocita',    abbr: 'RBA', color: '#1a3c66', color2: '#c52928', logo: 'rba_rbk--logo - 500x500.png', email: 'info@rbatascocita.com', fee: '50', domain: 'rbatascocita.com' },
  { name: 'Rowland Ballard - Kingwood',      abbr: 'RBK', color: '#1a3c66', color2: '#c52928', logo: 'rba_rbk--logo - 500x500.png', email: 'info@rbkingwood.com', fee: '50', domain: 'rbkingwood.com' },
  { name: 'Houston Gymnastics Academy',      abbr: 'HGA', color: '#c91724', color2: '#262626', logo: 'hga--logo - 500x500.png', email: 'info@houstongymnastics.com', fee: '55', domain: 'houstongymnastics.com' },
  { name: 'Estrella Gymnastics',             abbr: 'EST', color: '#011837', color2: '#666666', logo: 'est--logo - 500x500.png', email: 'info@estrellagym.com', fee: '55', domain: 'estrellagym.com' },
  { name: 'Oasis Gymnastics',                abbr: 'OAS', color: '#3eb29f', color2: '#3eb29f', logo: 'oasis--logo - 500x500.png', email: 'info@oasisgym.com', fee: '55', domain: 'oasisgym.com' },
  { name: 'Scottsdale Gymnastics',           abbr: 'SGT', color: '#c72b12', color2: '#e6e6e6', logo: 'sgt-logo - 500x500.png', email: 'info@scottsdalegymnastics.com', fee: '55', domain: 'scottsdalegymnastics.com' },
  { name: 'Tigar Gymnastics',                abbr: 'TIG', color: '#f57f20', color2: '#0a3651', logo: 'tigar--logo - 500x500.png', email: 'info@tigargym.com', fee: '55', domain: 'tigargym.com' }
];

/* ── Auth ── */
async function doLogin() {
  var pin = document.getElementById('pinInput').value;
  if (!pin) return;
  var errEl = document.getElementById('loginError');
  errEl.style.display = 'none';
  try {
    var resp = await fetch('/api/auth', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pin: pin })
    });
    var data = await resp.json();
    if (!resp.ok) {
      errEl.textContent = data.error || 'Login failed';
      errEl.style.display = 'block';
      return;
    }
    TOKEN = data.token;
    localStorage.setItem('admin_token', TOKEN);
    await initEditor();
  } catch (e) {
    errEl.textContent = 'Connection error. Make sure you are on the deployed site.';
    errEl.style.display = 'block';
  }
}

function doLogout() {
  TOKEN = null;
  localStorage.removeItem('admin_token');
  document.getElementById('editorScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('pinInput').value = '';
}

/* ── Init ── */
async function initEditor() {
  try {
    var resp = await fetch('/api/content');
    if (!resp.ok) throw new Error('Content not found');
    content = await resp.json();
  } catch (e) {
    showToast('Could not load content. Run /api/seed first.');
    return;
  }
  // Load gyms from API response or use defaults
  gyms = content.gyms || JSON.parse(JSON.stringify(DEFAULT_GYMS));
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('editorScreen').style.display = 'block';
  renderEditor();
  renderGymsEditor();
  buildPreviewGyms();
}

/* ── Tab Switching ── */
function switchTab(tab) {
  activeTab = tab;
  document.getElementById('tabGyms').classList.toggle('active', tab === 'gyms');
  document.getElementById('tabWaiver').classList.toggle('active', tab === 'waiver');
  document.getElementById('tabPolicy').classList.toggle('active', tab === 'policy');
  document.getElementById('gymsEditor').style.display = tab === 'gyms' ? '' : 'none';
  document.getElementById('waiverEditor').style.display = tab === 'waiver' ? '' : 'none';
  document.getElementById('policyEditor').style.display = tab === 'policy' ? '' : 'none';
}

/* ── Render Full Editor ── */
function renderEditor() {
  renderDocEditor('waiver');
  renderDocEditor('policy');
  hasUnsaved = false;
  updateSaveStatus();
}

function renderDocEditor(doc) {
  var container = document.getElementById(doc + 'Editor');
  var data = content[doc];
  var html = '';

  // Title
  if (doc === 'waiver') {
    html += buildSectionCard('Document Title', 'title', 'badge-title',
      '<div class="content-area heading-content" contenteditable="true" data-field="waiver.title" oninput="markUnsaved()">' + data.title.join('<br>') + '</div>');
    html += buildSectionCard('Warning Box', 'warning', 'badge-title',
      '<div class="content-area" contenteditable="true" data-field="waiver.warning" oninput="markUnsaved()">' + data.warning + '</div>');
  } else {
    html += buildSectionCard('Document Title', 'title', 'badge-title',
      '<div class="content-area heading-content" contenteditable="true" data-field="policy.title" oninput="markUnsaved()">' + data.title + '</div>');
    html += buildSectionCard('Intro Text', 'intro', 'badge-title',
      '<div class="content-area" contenteditable="true" data-field="policy.intro" oninput="markUnsaved()">' + data.intro + '</div>');
  }

  // Sections
  var sections = data.sections;
  for (var i = 0; i < sections.length; i++) {
    html += renderSectionCard(doc, i, sections[i], sections.length);
  }

  // Add buttons
  if (doc === 'waiver') {
    html += '<div class="add-section">' +
      '<button onclick="addSection(\'waiver\',\'p\')">+ Paragraph</button>' +
      '<button onclick="addSection(\'waiver\',\'indent\')">+ Indented Block</button>' +
      '<button onclick="addSection(\'waiver\',\'sig\')">+ Signature</button>' +
    '</div>';
  } else {
    html += '<div class="add-section">' +
      '<button onclick="addSection(\'policy\',\'h1\')">+ Section Heading</button>' +
      '<button onclick="addSection(\'policy\',\'h2\')">+ Sub-Heading</button>' +
      '<button onclick="addSection(\'policy\',\'p\')">+ Paragraph</button>' +
      '<button onclick="addSection(\'policy\',\'ul\')">+ Bullet List</button>' +
      '<button onclick="addSection(\'policy\',\'ol\')">+ Numbered List</button>' +
      '<button onclick="addSection(\'policy\',\'sig\')">+ Signature</button>' +
    '</div>';
  }

  container.innerHTML = html;
}

function buildSectionCard(labelText, badgeText, badgeClass, bodyHTML) {
  return '<div class="section-card">' +
    '<div class="section-label">' +
      '<div><span class="label-badge ' + badgeClass + '">' + badgeText + '</span> <span class="label-text">' + labelText + '</span></div>' +
    '</div>' +
    bodyHTML +
  '</div>';
}

function renderSectionCard(doc, idx, section, total) {
  var typeName = { p: 'Paragraph', indent: 'Indented Block', h1: 'Section Heading', h2: 'Sub-Heading', ul: 'Bullet List', ol: 'Numbered List', sig: 'Signature' };
  var badgeClass = { p: 'badge-paragraph', indent: 'badge-indent', h1: 'badge-heading', h2: 'badge-heading', ul: 'badge-list', ol: 'badge-list', sig: 'badge-sig' };

  var actions = '<div class="section-actions">' +
    (idx > 0 ? '<button title="Move up" onclick="moveSection(\'' + doc + '\',' + idx + ',-1)">&#9650;</button>' : '') +
    (idx < total - 1 ? '<button title="Move down" onclick="moveSection(\'' + doc + '\',' + idx + ',1)">&#9660;</button>' : '') +
    '<button title="Delete" onclick="deleteSection(\'' + doc + '\',' + idx + ')">&#10005;</button>' +
  '</div>';

  var bodyHTML = '';
  if (section.type === 'p' || section.type === 'indent') {
    bodyHTML = '<div class="content-area" contenteditable="true" data-doc="' + doc + '" data-idx="' + idx + '" data-field="html" oninput="markUnsaved()">' + (section.html || '') + '</div>';
  } else if (section.type === 'h1' || section.type === 'h2') {
    bodyHTML = '<div class="content-area heading-content" contenteditable="true" data-doc="' + doc + '" data-idx="' + idx + '" data-field="text" oninput="markUnsaved()">' + (section.text || '') + '</div>';
  } else if (section.type === 'ul' || section.type === 'ol') {
    bodyHTML = renderListEditorHTML(doc, idx, section);
  } else if (section.type === 'sig') {
    bodyHTML = '<div class="sig-preview">Signature fields: ' + section.lines.map(function(row) {
      return row.map(function(f) { return f.label; }).join(', ');
    }).join(' | ') + '</div>';
  }

  return '<div class="section-card">' +
    '<div class="section-label">' +
      '<div><span class="label-badge ' + (badgeClass[section.type] || 'badge-paragraph') + '">' + section.type.toUpperCase() + '</span> <span class="label-text">' + (typeName[section.type] || section.type) + ' #' + (idx + 1) + '</span></div>' +
      actions +
    '</div>' +
    bodyHTML +
  '</div>';
}

function renderListEditorHTML(doc, sectionIdx, section) {
  var html = '<div class="list-content">';
  var items = section.items || [];
  for (var j = 0; j < items.length; j++) {
    var marker = section.type === 'ol' ? (j + 1) + '.' : '\u2022';
    html += '<div class="list-item-row">' +
      '<span class="marker">' + marker + '</span>' +
      '<div class="item-content" contenteditable="true" data-doc="' + doc + '" data-section="' + sectionIdx + '" data-item="' + j + '" oninput="markUnsaved()">' + (items[j].html || '') + '</div>' +
      '<button title="Remove" onclick="removeListItem(\'' + doc + '\',' + sectionIdx + ',' + j + ')">&#10005;</button>' +
    '</div>';
  }
  html += '<button class="add-item-btn" onclick="addListItem(\'' + doc + '\',' + sectionIdx + ')">+ Add Item</button>';
  html += '</div>';
  return html;
}

/* ── Sync contenteditable back to data ── */
function syncFromEditor() {
  // Meta fields
  var el;
  el = document.querySelector('[data-field="waiver.title"]');
  if (el) content.waiver.title = el.innerHTML.split(/<br\s*\/?>/i).filter(function(l) { return l.trim(); });
  el = document.querySelector('[data-field="waiver.warning"]');
  if (el) content.waiver.warning = el.innerHTML;
  el = document.querySelector('[data-field="policy.title"]');
  if (el) content.policy.title = el.textContent;
  el = document.querySelector('[data-field="policy.intro"]');
  if (el) content.policy.intro = el.innerHTML;

  // Section content areas
  document.querySelectorAll('.content-area[data-doc]').forEach(function(area) {
    var doc = area.dataset.doc;
    var idx = parseInt(area.dataset.idx);
    var field = area.dataset.field;
    content[doc].sections[idx][field] = area.innerHTML;
  });

  // List items
  document.querySelectorAll('.item-content[data-doc]').forEach(function(item) {
    var doc = item.dataset.doc;
    var sectionIdx = parseInt(item.dataset.section);
    var itemIdx = parseInt(item.dataset.item);
    content[doc].sections[sectionIdx].items[itemIdx].html = item.innerHTML;
  });
}

/* ── Section CRUD ── */
function addSection(doc, type) {
  syncFromEditor();
  var sections = content[doc].sections;
  var newSection = { type: type };
  if (type === 'p' || type === 'indent') newSection.html = '';
  else if (type === 'h1' || type === 'h2') newSection.text = '';
  else if (type === 'ul' || type === 'ol') newSection.items = [{ html: '' }];
  else if (type === 'sig') newSection.lines = [[{ label: 'Signature', flex: 2 }, { label: 'Date', flex: 1 }]];
  sections.push(newSection);
  renderDocEditor(doc);
  markUnsaved();
}

function deleteSection(doc, idx) {
  if (!confirm('Delete this section?')) return;
  syncFromEditor();
  content[doc].sections.splice(idx, 1);
  renderDocEditor(doc);
  markUnsaved();
}

function moveSection(doc, idx, dir) {
  syncFromEditor();
  var sections = content[doc].sections;
  var newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= sections.length) return;
  var temp = sections[idx];
  sections[idx] = sections[newIdx];
  sections[newIdx] = temp;
  renderDocEditor(doc);
  markUnsaved();
}

function addListItem(doc, sectionIdx) {
  syncFromEditor();
  content[doc].sections[sectionIdx].items.push({ html: '' });
  renderDocEditor(doc);
  markUnsaved();
}

function removeListItem(doc, sectionIdx, itemIdx) {
  syncFromEditor();
  content[doc].sections[sectionIdx].items.splice(itemIdx, 1);
  renderDocEditor(doc);
  markUnsaved();
}

/* ── Gym Editor ── */
function renderGymsEditor() {
  var container = document.getElementById('gymsEditor');
  var html = '';
  for (var i = 0; i < gyms.length; i++) {
    var g = gyms[i];
    html += '<div class="gym-card-admin">' +
      '<div class="gym-card-header">' +
        (g.logo ? '<img class="gym-logo-preview" src="' + g.logo + '" onerror="this.style.display=\'none\'">' : '') +
        '<span class="gym-name-label">' + (g.name || 'New Gym') + '</span>' +
        '<div class="color-dots">' +
          '<div class="color-dot" style="background:' + (g.color || '#ccc') + '" title="Primary Color"></div>' +
          '<div class="color-dot" style="background:' + (g.color2 || '#ccc') + '" title="Secondary Color"></div>' +
        '</div>' +
      '</div>' +
      '<div class="gym-card-body">' +
        gymField('Gym Name', 'text', g.name, i, 'name') +
        gymField('Abbreviation', 'text', g.abbr, i, 'abbr') +
        gymField('Email', 'text', g.email, i, 'email') +
        gymField('Annual Fee ($)', 'text', g.fee, i, 'fee') +
        gymField('Email Domain', 'text', g.domain, i, 'domain') +
        gymField('Logo Filename', 'text', g.logo, i, 'logo') +
        gymFieldColor('Primary Color', g.color, i, 'color') +
        gymFieldColor('Secondary Color', g.color2, i, 'color2') +
      '</div>' +
      '<div class="gym-card-actions">' +
        '<button class="btn-remove" onclick="removeGym(' + i + ')">Remove Gym</button>' +
      '</div>' +
    '</div>';
  }
  html += '<button class="add-gym-btn" onclick="addGym()">+ Add New Gym</button>';
  container.innerHTML = html;
}

function gymField(label, type, value, idx, field) {
  return '<div class="gym-field">' +
    '<label>' + label + '</label>' +
    '<input type="' + type + '" value="' + (value || '').replace(/"/g, '&quot;') + '" oninput="updateGym(' + idx + ',\'' + field + '\',this.value)">' +
  '</div>';
}

function gymFieldColor(label, value, idx, field) {
  return '<div class="gym-field">' +
    '<label>' + label + '</label>' +
    '<input type="color" value="' + (value || '#666666') + '" oninput="updateGymColor(' + idx + ',\'' + field + '\',this.value)">' +
  '</div>';
}

function updateGym(idx, field, value) {
  gyms[idx][field] = value;
  // Update header label if name changed
  if (field === 'name') {
    var headers = document.querySelectorAll('.gym-name-label');
    if (headers[idx]) headers[idx].textContent = value || 'New Gym';
  }
  markUnsaved();
}

function updateGymColor(idx, field, value) {
  gyms[idx][field] = value;
  // Update color dot preview
  var cards = document.querySelectorAll('.gym-card-admin');
  if (cards[idx]) {
    var dots = cards[idx].querySelectorAll('.color-dot');
    if (field === 'color' && dots[0]) dots[0].style.background = value;
    if (field === 'color2' && dots[1]) dots[1].style.background = value;
  }
  markUnsaved();
}

function addGym() {
  gyms.push({ name: '', abbr: '', color: '#666666', color2: '#999999', logo: '', email: '', fee: '55', domain: '' });
  renderGymsEditor();
  markUnsaved();
  // Scroll to the new gym card
  var cards = document.querySelectorAll('.gym-card-admin');
  if (cards.length) cards[cards.length - 1].scrollIntoView({ behavior: 'smooth' });
}

function removeGym(idx) {
  if (!confirm('Remove ' + (gyms[idx].name || 'this gym') + '? This cannot be undone after saving.')) return;
  gyms.splice(idx, 1);
  renderGymsEditor();
  markUnsaved();
}

/* ── Save ── */
async function saveContent() {
  syncFromEditor();
  content.gyms = gyms;
  var btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    var resp = await fetch('/api/content', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + TOKEN },
      body: JSON.stringify(content)
    });
    if (resp.status === 401) { showToast('Session expired. Please log in again.'); doLogout(); return; }
    if (!resp.ok) { var err = await resp.json(); showToast('Save failed: ' + (err.error || 'Unknown error')); return; }
    hasUnsaved = false;
    updateSaveStatus();
    showToast('Saved!');
  } catch (e) {
    showToast('Network error. Check your connection.');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
}

/* ── Status ── */
function markUnsaved() { hasUnsaved = true; updateSaveStatus(); }
function updateSaveStatus() {
  var el = document.getElementById('saveStatus');
  if (hasUnsaved) { el.textContent = 'Unsaved changes'; el.className = 'save-status unsaved'; }
  else { el.textContent = 'All changes saved'; el.className = 'save-status'; }
}

/* ── Preview ── */
function buildPreviewGyms() {
  var sel = document.getElementById('previewGym');
  sel.innerHTML = gyms.map(function(g, i) { return '<option value="' + i + '">' + g.name + '</option>'; }).join('');
}

function openPreview() {
  syncFromEditor();
  buildPreviewGyms();
  document.getElementById('previewDoc').value = (activeTab === 'gyms') ? 'waiver' : activeTab;
  document.getElementById('previewModal').classList.add('open');
  renderPreview();
}

function closePreview() { document.getElementById('previewModal').classList.remove('open'); }

function substituteVars(text, gym) {
  if (!text) return text;
  return text.replace(/\{\{gym\.name\}\}/g, gym.name)
             .replace(/\{\{gym\.fee\}\}/g, String(gym.fee))
             .replace(/\{\{gym\.domain\}\}/g, gym.domain)
             .replace(/\{\{gym\.email\}\}/g, gym.email || '')
             .replace(/\{\{gym\.color\}\}/g, gym.color || '')
             .replace(/\{\{gym\.color2\}\}/g, gym.color2 || '')
             .replace(/\{\{gym\.abbr\}\}/g, gym.abbr || '');
}

function renderPreview() {
  var gym = gyms[document.getElementById('previewGym').value];
  var docType = document.getElementById('previewDoc').value;
  var body = document.getElementById('previewBody');

  if (docType === 'waiver') {
    var w = content.waiver;
    var title = w.title.map(function(t) { return substituteVars(t, gym); }).join('<br>');
    var html = '<h1>' + title + '</h1>';
    html += '<div class="warning">' + substituteVars(w.warning, gym) + '</div>';
    html += renderSectionsPreview(w.sections, gym);
    body.innerHTML = html;
  } else {
    var p = content.policy;
    var html = '<h1>' + p.title + '</h1>';
    html += '<div class="policy-intro">' + substituteVars(p.intro, gym) + '</div>';
    html += renderSectionsPreview(p.sections, gym);
    body.innerHTML = html;
  }
}

function renderSectionsPreview(sections, gym) {
  var html = '';
  for (var i = 0; i < sections.length; i++) {
    var s = sections[i];
    switch (s.type) {
      case 'h1': html += '<h1>' + substituteVars(s.text, gym) + '</h1>'; break;
      case 'h2': html += '<h2>' + substituteVars(s.text, gym) + '</h2>'; break;
      case 'p': html += '<p>' + substituteVars(s.html || '', gym) + '</p>'; break;
      case 'indent': html += '<p style="padding-left:20px;">' + substituteVars(s.html, gym) + '</p>'; break;
      case 'ul':
        html += '<ul>';
        for (var j = 0; j < (s.items || []).length; j++) {
          html += '<li>' + substituteVars(s.items[j].html, gym);
          if (s.items[j].sub) { html += '<ul>'; for (var k = 0; k < s.items[j].sub.length; k++) html += '<li>' + substituteVars(s.items[j].sub[k], gym) + '</li>'; html += '</ul>'; }
          html += '</li>';
        }
        html += '</ul>'; break;
      case 'ol':
        html += '<ol>';
        for (var j = 0; j < (s.items || []).length; j++) html += '<li>' + substituteVars(s.items[j].html, gym) + '</li>';
        html += '</ol>'; break;
      case 'sig':
        for (var ri = 0; ri < s.lines.length; ri++) {
          html += '<div class="sig-area">';
          for (var fi = 0; fi < s.lines[ri].length; fi++) html += '<div style="flex:' + s.lines[ri][fi].flex + ';"><div class="sig-line"></div><div class="sig-label">' + s.lines[ri][fi].label + '</div></div>';
          html += '</div>';
        }
        break;
    }
  }
  return html;
}

/* ── Helpers ── */
function copyVar(text) {
  navigator.clipboard.writeText(text).then(function() { showToast('Copied: ' + text); });
}

function showToast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 2500);
}

/* ── Keyboard ── */
document.getElementById('pinInput').addEventListener('keydown', function(e) { if (e.key === 'Enter') doLogin(); });
window.addEventListener('beforeunload', function(e) { if (hasUnsaved) { e.preventDefault(); e.returnValue = ''; } });

/* ── Auto-login ── */
if (TOKEN) { initEditor().catch(function() { doLogout(); }); }
</script>
</body>
</html>
